{% set image = entry.imageAsset.eagerly().one() %}
{% set currentAspectAspect = 'auto' %}
{% set xFormWidth = '' %}
{% set xFormHeight = '' %}
{% set adSettings = entry.imageArtDirection.eagerly().all() %}
{% set imgSettings = entry.imageSettings.eagerly().all() %}

{# set frame aspect ratio and image position classes #}
{% set frameClasses = ['block', 'relative', 'w-full'] %}
{% set imgClasses = ['block', 'w-full'] %}
{% set aspectValues =  {
	'df': 'h-auto',	
	'@xs': null,
	'@sm': null,
	'@md': null,
	'@lg': null,
	'@xl': null,
	'@2xl': null,	
} %}
{% set posValues =  {
	'df': 'object-center',	
	'@xs': null,
	'@sm': null,
	'@md': null,
	'@lg': null,
	'@xl': null,
	'@2xl': null,	
} %}

{% for adjustment in adSettings %}
	{% if adjustment.layoutSize.value == '' %}
		{% if adjustment.frameAspect.value != '' %}
			{% set aspectValues  = aspectValues|merge({'df': 'aspect-' ~ adjustment.frameAspect.value })%}
		{% endif %}
		{% if adjustment.imagePosition.value != '' %}
			{% set posValues  = posValues|merge({'df': 'object-' ~ adjustment.imagePosition.value })%}
		{% endif %}
	{% else %}
		{% if adjustment.frameAspect.value != '' %}			
			{% set aspectValues  = aspectValues|merge({ (adjustment.layoutSize.value) : 'aspect-' ~ adjustment.frameAspect.value })%}
		{% endif %}
		{% if adjustment.imagePosition.value != '' %}
			{% set posValues  = posValues|merge({ (adjustment.layoutSize.value) : 'object-' ~ adjustment.imagePosition.value })%}
		{% endif %}
	{% endif %}
{% endfor %}

{% for key,value in aspectValues %}
	{% if value != null %}
		{% if key == 'df' %}
			{% set frameClasses = frameClasses|merge([value]) %}
			{% set imgClasses = imgClasses|merge([value]) %}
		{% else %}
			{% set frameClasses = frameClasses|merge([key ~ ':' ~ value]) %}
			{% set imgClasses = imgClasses|merge([key ~ ':' ~ value]) %}
		{% endif %}
	{% endif %}
{% endfor %}

{% for key,value in posValues %}
	{% if value != null %}
		{% if key == 'df' %}
			{% set imgClasses = imgClasses|merge([value]) %}
		{% else %}
			{% set imgClasses = imgClasses|merge([key ~ ':' ~ value]) %}
		{% endif %}
	{% endif %}
{% endfor %}

<picture class="{{ frameClasses|join(' ') }}">
	{# set ordered array of objects for source settings #}
	{% set srcObjects =  {
		'df': {'minSize': 0, 'aspect': 'auto', 'image': image},
		'xs': {'minSize': 320, 'aspect': null, 'image': null},
		'sm': {'minSize': 640, 'aspect': null, 'image': null},
		'md': {'minSize': 768, 'aspect': null, 'image': null},
		'lg': {'minSize': 1024, 'aspect': null, 'image': null},
		'xl': {'minSize': 1280, 'aspect': null, 'image': null},
		'2xl': {'minSize': 1536, 'aspect': null, 'image': null},		
	} %}

	{% for srcSetting in imgSettings %}
		{# if there is a new image in the adjustment then use it as the image for src attributes #}
		{% if srcSetting.deviceSize == '' %}
			{% set srcSize = 'df' %}
		{% else %}
			{% set srcSize = srcSetting.deviceSize.value %}
		{% endif %}

		{% if srcSetting.imageAsset|length or srcSetting.aspectRatio != '' %}
			{% if srcSetting.imageAsset|length and srcSetting.deviceSize != '' %}
				{% set image = srcSetting.imageAsset.eagerly().one() %}
			{% endif %}
			{% if srcSetting.aspectRatio.value != '' %}				
				{% set currentAspect = srcSetting.aspectRatio.value %}
			{% else %}
				{% set myRatio = currentAspect %}
			{% endif %}
			{% set mySrcObject = srcObjects[(srcSize)] %}			
			{% set mySrcObject = mySrcObject|merge({'image': image, 'aspect': currentAspect}) %}
			{% set srcObjects = srcObjects|merge({(srcSize): mySrcObject}) %}

		{% endif %}		
	{% endfor %}
		
	{# loop through and write in src elements for different breakpoints #}
	
	{% for sizeKey, srcSettings in srcObjects|reverse %}		
		{% if srcSettings.image != null or srcSettings.aspect != null %}
			{% if srcSettings.aspect == 'auto' %}
				{% set xForm = 'contentImage' %}				
			{% else %}
				{% set xForm = 'image-' ~ srcSettings.aspect %}				
			{% endif %}
			{% set transformedImages = craft.imagerx.transformImage(srcSettings.image, xForm) %}
			{% if sizeKey == 'df' %}
				{% if srcSettings.aspect == 'auto' %}				
					{% set xFormWidth = srcSettings.image.width %}
					{% set xFormHeight = srcSettings.image.height %}
				{% else %}				
					{% if srcSettings.aspect == 'video' %}
						{% set numerator = 16 %}
						{% set denominator = 9 %} 
					{% elseif srcSettings.aspect == 'square' %}
						{% set numerator = 1 %}
						{% set denominator = 1 %} 
					{% else %}
						{% set numerator = srcSettings.aspect|split('/')|first %}
						{% set denominator = srcSettings.aspect|split('/')|last %}        
					{% endif %}
					{% set xFormWidth = srcSettings.image.width %}				
					{% set xFormHeight = (srcSettings.image.width * denominator) / numerator %}				
				{% endif %}
				
				<img src="{{ craft.imager.placeholder({width: xFormWidth, height: xFormHeight}) }}"
					width="{{xFormWidth}}"
					height="{{xFormHeight}}"
					{% if entry.lazyLoadImg %}
						sizes="auto"
					{% else %}
						fetchpriority="high"
					{% endif %}    
					srcset="{{ craft.imager.srcset(transformedImages) }}"
					alt="{{ entry.altText }}"
					class="{{imgClasses|join(' ')}}"
					loading="{{entry.lazyLoadImg ? 'lazy' : 'eager'}}"
					decoding="async"
				>
			{% else %}
				<source sizes="auto" media="(min-width: {{srcSettings.minSize}}px)" srcset="{{ craft.imager.srcset(transformedImages) }}" {% if craft.imager.serverSupportsWebp() %}type="image/webp"{% endif %}>
			{% endif %}
		{% endif %}
	{% endfor %}

</picture>

